@page "{id:guid}"
@model OnlineNet.WebApp.Pages.Customers.DetailsModel
@{
    ViewData["Title"] = $"Customer - {Model.Customer?.FullName ?? "Details"}";
}

<a class="btn btn-link px-0" asp-page="/Customers/Index">&larr; Back to customers</a>

@if (Model.Customer is null)
{
    <div class="alert alert-danger mt-3">Customer not found.</div>
}
else
{
    <section class="card mt-3">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-start">
                <div>
                    <h1 class="card-title h3 mb-1">@Model.Customer.FullName</h1>
                    <p class="card-text mb-0">@Model.Customer.Email</p>
                </div>
                <a class="btn btn-outline-primary" asp-page="/Shop/Index" asp-route-customerId="@Model.Customer.Id">Open in shop</a>
            </div>
            <dl class="row mt-3 mb-0">
                <dt class="col-sm-3">Customer ID</dt>
                <dd class="col-sm-9">@Model.Customer.Id</dd>
                <dt class="col-sm-3">Created</dt>
                <dd class="col-sm-9">@Model.Customer.CreatedOn.ToLocalTime().ToString("f")</dd>
                <dt class="col-sm-3">Last updated</dt>
                <dd class="col-sm-9">@(Model.Customer.ModifiedOn?.ToLocalTime().ToString("f") ?? "Never")</dd>
                <dt class="col-sm-3">Active basket</dt>
                <dd class="col-sm-9">@(Model.Customer.ActiveBasketId?.ToString() ?? "None")</dd>
            </dl>
        </div>
    </section>

    <div class="row mt-4 g-4">
        <div class="col-lg-6">
            <section class="card h-100">
                <div class="card-body">
                    <h2 class="h5">Current basket</h2>

                    @if (Model.Basket is null || !Model.Basket.HasItems)
                    {
                        <div class="alert alert-light mb-0">The basket is empty.</div>
                    }
                    else
                    {
                        <div class="table-responsive">
                            <table class="table table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Product</th>
                                        <th class="text-end">Quantity</th>
                                        <th class="text-end">Unit price</th>
                                        <th class="text-end">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var item in Model.Basket.Items)
                                    {
                                        <tr>
                                            <td>@item.ProductName</td>
                                            <td class="text-end">@item.Quantity</td>
                                            <td class="text-end">@item.UnitPrice.ToString("N2") @item.Currency</td>
                                            <td class="text-end">@item.Subtotal.ToString("N2") @item.Currency</td>
                                        </tr>
                                    }
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <th colspan="3" class="text-end">Total</th>
                                        <th class="text-end">@Model.Basket.Total.ToString("N2") @Model.Basket.Currency</th>
                                    </tr>
                                </tfoot>
                            </table>
                        </div>
                    }
                </div>
            </section>
        </div>
        <div class="col-lg-6">
            <section class="card h-100">
                <div class="card-body">
                    <h2 class="h5">Recent orders</h2>

                    @if (Model.Orders.Count == 0)
                    {
                        <div class="alert alert-info mb-0">No orders found for this customer.</div>
                    }
                    else
                    {
                        <ul class="list-group list-group-flush">
                            @foreach (var order in Model.Orders)
                            {
                                <li class="list-group-item">
                                    <div class="d-flex justify-content-between">
                                        <span>
                                            <strong>Order #@order.Id.ToString()[..8]</strong>
                                            <small class="text-muted">@order.CreatedOn.ToLocalTime().ToString("g")</small>
                                        </span>
                                        <span class="badge bg-secondary">@order.Status</span>
                                    </div>
                                    <div class="mt-2">
                                        <strong>Total:</strong> @order.TotalAmount.ToString("N2") @order.Currency<br />
                                        <strong>Lines:</strong> @order.Lines.Count
                                    </div>
                                </li>
                            }
                        </ul>
                    }
                </div>
            </section>
        </div>
    </div>
}
